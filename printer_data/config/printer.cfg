# This file contains common pin mappings for the BIGTREETECH SKR V1.4
# board. To use this config, the firmware should be compiled for the
# LPC1768 or LPC1769(Turbo).

# See docs/Config_Reference.md for a description of parameters.

## Webclient config files. Uncomment one depending on UI being used.
[include mainsail.cfg]
#[include fluidd.cfg] 

#[include accelerometer.cfg]

[include timelapse.cfg]
[include stealthburner_leds.cfg]
[include backup.cfg]

[exclude_object]
[include KAMP_Settings.cfg]
[include macros.cfg]
[include menu.cfg]
[include splash.cfg]

[motor_constants 42BYGH47-401A]
resistance: 1.6
inductance: 0.0028
holding_torque: 0.55
max_current: 1.5
steps_per_revolution: 200

############################################################
# X Stepper Settings
############################################################

[stepper_x]
step_pin: P2.2
dir_pin: !P2.6
enable_pin: !P2.1
rotation_distance: 32
#full_steps_per_rotation: 200
microsteps: 16
endstop_pin: tmc2209_stepper_x:virtual_endstop #sensorless homing
# endstop_pin: P1.29
position_min: 0
position_endstop: 0
position_max: 250
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: P1.10
run_current: 0.85
diag_pin: ^P1.29
#driver_SGTHRS: 70
interpolate: true
stealthchop_threshold: 0

[autotune_tmc stepper_x]
motor: 42BYGH47-401A
tuning_goal: performance
sg4_thrs: 70

############################################################
# Y Stepper Settings
############################################################

[stepper_y]
step_pin: P0.19
dir_pin: P0.20
enable_pin: !P2.8
rotation_distance: 32
#full_steps_per_rotation: 200
microsteps: 16
endstop_pin: tmc2209_stepper_y:virtual_endstop  #sensorless homing
# endstop_pin: P1.28
position_endstop: -25
position_min: -25
position_max: 250
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_y]
uart_pin: P1.9
run_current: 0.85
diag_pin: ^P1.28
#driver_SGTHRS: 70
interpolate: true
stealthchop_threshold: 0

[autotune_tmc stepper_y]
motor: 42BYGH47-401A
tuning_goal: performance
sg4_thrs: 70

############################################################
# Z Stepper Settings
############################################################

[stepper_z]
step_pin: P0.22
dir_pin: !P2.11
enable_pin: !P0.21
rotation_distance: 32
#full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
# endstop_pin: P1.27
position_max: 400
homing_speed: 40
position_min: -3

[tmc2209 stepper_z]
uart_pin: P1.8
run_current: 0.85
interpolate: true
stealthchop_threshold: 0

[autotune_tmc stepper_z]
motor: 42BYGH47-401A
tuning_goal: performance

############################################################
# Extruder Stepper Settings
############################################################

[extruder]
step_pin: P2.13
dir_pin: P0.11
enable_pin: !P2.12
rotation_distance: 54.13379544  # Re-calibrate your own value
gear_ratio: 44:10, 37:17
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: P2.7
sensor_type: Generic 3950
sensor_pin: P0.24
#control: pid
#pid_Kp: 37.413
#pid_Ki: 3.837
#pid_Kd: 91.195
min_temp: 0
max_temp: 260
max_extrude_only_distance: 101.0
max_extrude_cross_section: 5
#min_extrude_temp: 0

[tmc2209 extruder]
uart_pin: P1.4
run_current: 0.650
interpolate: true

[autotune_tmc stepper_z]
motor: ldo-36sth20-1004ahg

[firmware_retraction]
retract_length: 0.4

############################################################
# Bed Settings
############################################################

[heater_bed]
heater_pin: P2.5
sensor_type: ATC Semitec 104GT-2
sensor_pin: P0.25
min_temp: -10
max_temp: 130
#control: pid
#pid_kp: 68.646
#pid_ki: 0.963
#pid_kd: 1222.764

############################################################
# Homing and Bed Leveling
############################################################
[include eddy.cfg]

[screws_tilt_adjust]
screw1: 20,2 
screw1_name: front left screw
screw2: 230,2
screw2_name: front right screw
screw3: 230,211
screw3_name: rear right screw
screw4: 20,211
screw4_name: rear left screw
horizontal_move_z: 5
speed: 80
screw_thread: CW-M3

############################################################
# Mechanics and Electronics
############################################################

[printer]
kinematics: corexz
max_velocity: 200
max_accel: 4000
square_corner_velocity: 5.0
max_z_velocity: 100
max_z_accel: 1000

[mcu]
serial: /dev/serial/by-id/usb-Klipper_lpc1768_17E0FF0FC720FAAEE6B2D957C72000F5-if00
restart_method: command

[mcu host]
serial: /tmp/klipper_host_mcu

[fan]
pin: P2.4
off_below: 0.1

[heater_fan hotend_fan]
pin: P2.3
off_below: 0.1
heater: extruder

[duplicate_pin_override]
pins: P0.25

[temperature_fan nevermore_fan]
pin: P1.16
off_below: 0.1
min_temp: 0
max_temp: 120.0
sensor_type: ATC Semitec 104GT-2
sensor_pin: P0.25
control: watermark
target_temp: 70


[filament_switch_sensor RunoutSensor]
pause_on_runout: True
runout_gcode: _warning_beep
switch_pin: !P1.0

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[idle_timeout]
gcode:
  {% if printer.pause_resume.is_paused %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True
    {action_respond_info("Idle Timeout: Extruder powered down")}
    M104 S0   ; Set Hot-end to 0C (off)
  {% else %}
    {action_respond_info("Idle Timeout: Stepper and Heater powered down")}
    TURN_OFF_HEATERS
    M84
  {% endif %}
  
[axis_twist_compensation]
calibrate_start_x: 15
calibrate_end_x: 235
calibrate_y: 125
calibrate_start_y: 18.42
calibrate_end_y: 235
calibrate_x: 125

[input_shaper]
#shaper_freq_x: 55.4
#shaper_type_x: mzv
#shaper_freq_y: 42.6
#shaper_type_y: mzv
    
########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=P1.30, EXP1_3=P1.18, EXP1_5=P1.20, EXP1_7=P1.22, EXP1_9=<GND>,
    EXP1_2=P0.28, EXP1_4=P1.19, EXP1_6=P1.21, EXP1_8=P1.23, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=P0.17, EXP2_3=P3.26, EXP2_5=P3.25, EXP2_7=P1.31, EXP2_9=<GND>,
    EXP2_2=P0.15, EXP2_4=P0.16, EXP2_6=P0.18, EXP2_8=<RST>, EXP2_10=<NC>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp0"

# See the sample-lcd.cfg file for definitions of common LCD displays.

######################################################################
# "RepRapDiscount 128x64 Full Graphic Smart Controller" type displays
######################################################################

[display]
lcd_type: st7920
cs_pin: EXP1_4
sclk_pin: EXP1_5
sid_pin: EXP1_3
encoder_pins: ^EXP2_3, ^EXP2_5
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8

[output_pin beeper]
pin: EXP1_1

######################################################################
# MKS Mini 12864 LCD
######################################################################

# Make sure that the EXP1 and EXP2 are rotated correctly on the
# display board. The cutouts on the connectors should be towards the
# center of the PCB. See:
#   https://reprap.org/wiki/MKS_MINI_12864#Physical_Interface
# If they are wrong, the connector housing can be pried off carefully
# with a small screwdriver and relocated the correct way.

#[display]
#lcd_type: uc1701
#cs_pin: EXP1_6
#a0_pin: EXP1_7
#contrast: 40
#encoder_pins: ^EXP2_3, ^EXP2_5
#click_pin: ^!EXP1_2
## Some micro-controller boards may require an spi bus to be specified:
#spi_bus: spi
## Alternatively, some micro-controller boards may work with software spi:
#spi_software_miso_pin: EXP2_1
#spi_software_mosi_pin: EXP2_6
#spi_software_sclk_pin: EXP2_2

#[output_pin beeper]
#pin: EXP1_1

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 37.430
#*# pid_ki = 5.803
#*# pid_kd = 60.357
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 68.572
#*# pid_ki = 1.184
#*# pid_kd = 992.586
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.050000:3285304.164,0.090000:3284118.054,0.130000:3282835.647,
#*# 	0.170000:3281494.272,0.210000:3280056.458,0.250000:3278762.332,
#*# 	0.290000:3277572.531,0.330000:3276212.325,0.370000:3274897.324,
#*# 	0.410000:3273716.362,0.450000:3272605.151,0.490000:3271348.439,
#*# 	0.530000:3270104.293,0.570000:3268943.624,0.610000:3267912.083,
#*# 	0.650000:3266822.854,0.690000:3265644.916,0.730000:3264590.815,
#*# 	0.770000:3263630.195,0.810000:3262570.812,0.850000:3261478.395,
#*# 	0.890000:3260525.463,0.930000:3259597.493,0.970000:3258620.349,
#*# 	1.010000:3257557.536,1.050000:3256671.451,1.090000:3255835.924,
#*# 	1.130000:3254890.876,1.170000:3253931.367,1.210000:3253063.236,
#*# 	1.250000:3252231.828,1.290000:3251389.496,1.330000:3250461.841,
#*# 	1.370000:3249685.738,1.410000:3248966.852,1.450000:3248154.931,
#*# 	1.490000:3247345.801,1.530000:3246548.608,1.570000:3245881.550,
#*# 	1.610000:3245150.594,1.650000:3244371.681,1.690000:3243661.897,
#*# 	1.730000:3243021.728,1.770000:3242340.416,1.810000:3241596.787,
#*# 	1.850000:3240902.306,1.890000:3240294.935,1.930000:3239621.636,
#*# 	1.970000:3238944.806,2.010000:3238324.011,2.050000:3237743.593,
#*# 	2.090000:3237096.714,2.130000:3236462.161,2.170000:3235902.241,
#*# 	2.210000:3235341.017,2.250000:3234771.314,2.290000:3234158.839,
#*# 	2.330000:3233621.881,2.370000:3233168.088,2.410000:3232645.907,
#*# 	2.450000:3232083.632,2.490000:3231557.025,2.530000:3231086.247,
#*# 	2.570000:3230603.827,2.610000:3230063.871,2.650000:3229568.008,
#*# 	2.690000:3229129.688,2.730000:3228679.510,2.770000:3228192.749,
#*# 	2.810000:3227748.483,2.850000:3227351.233,2.890000:3226898.147,
#*# 	2.930000:3226450.033,2.970000:3226050.835,3.010000:3225652.270,
#*# 	3.050000:3225243.053,3.090000:3224842.569,3.130000:3224469.831,
#*# 	3.170000:3224127.784,3.210000:3223733.048,3.250000:3223298.852,
#*# 	3.290000:3222955.277,3.330000:3222627.862,3.370000:3222266.846,
#*# 	3.410000:3221913.446,3.450000:3221582.519,3.490000:3221279.581,
#*# 	3.530000:3220933.192,3.570000:3220604.837,3.610000:3220295.938,
#*# 	3.650000:3220031.995,3.690000:3219706.267,3.730000:3219418.807,
#*# 	3.770000:3219107.639,3.810000:3218829.727,3.850000:3218539.583,
#*# 	3.890000:3218239.281,3.930000:3217974.064,3.970000:3217702.191,
#*# 	4.010000:3217441.637,4.050000:3217196.365
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.264191, 0.156297, 0.147601, 0.201703, 0.263679, 0.296327, 0.330978, 0.355032, 0.313695
#*# 	0.236823, 0.156946, 0.160984, 0.207073, 0.246327, 0.267204, 0.286516, 0.296742, 0.292027
#*# 	0.249731, 0.155917, 0.157179, 0.199842, 0.250250, 0.274976, 0.317281, 0.332324, 0.273113
#*# 	0.269176, 0.173602, 0.173170, 0.209217, 0.254998, 0.266386, 0.292017, 0.288943, 0.274244
#*# 	0.271296, 0.182734, 0.171916, 0.214120, 0.258193, 0.299259, 0.336047, 0.347576, 0.289332
#*# 	0.274789, 0.179419, 0.176348, 0.210859, 0.248461, 0.274756, 0.312875, 0.313706, 0.294703
#*# 	0.252281, 0.148018, 0.143996, 0.193000, 0.247519, 0.268165, 0.312499, 0.324034, 0.271329
#*# 	0.252913, 0.156208, 0.153420, 0.191082, 0.234261, 0.260901, 0.284139, 0.294565, 0.278878
#*# 	0.305206, 0.196552, 0.194814, 0.236401, 0.278380, 0.315178, 0.353149, 0.369432, 0.328828
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.5
#*# min_x = 15.0
#*# max_x = 235.0
#*# min_y = 18.42
#*# max_y = 234.97999999999996
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.146467, -0.068244, 0.179835
#*# compensation_start_x = 15.0
#*# compensation_end_x = 235.0
#*# zy_compensations = -0.071688, 0.028287, 0.008526
#*# compensation_start_y = 18.42
#*# compensation_end_y = 235.0
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 40.692221
#*# drift_calibration =
#*# 	3306615.802657, -669.665417, 2.261950
#*# 	3287161.890378, -569.747808, 2.094009
#*# 	3266933.446901, -288.182869, -0.083671
#*# 	3249277.720065, -19.683798, -2.104487
#*# 	3236506.481549, 127.158422, -2.982185
#*# 	3226229.315246, 248.007289, -3.744125
#*# 	3218371.752830, 333.816135, -4.330133
#*# 	3212611.358802, 376.637330, -4.500815
#*# 	3208763.509058, 381.565937, -4.373766
#*# drift_calibration_min_temp = 35.61385680555496
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 55.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 42.6
